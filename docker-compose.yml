version: '3.8'

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://apelsin_user:ApelsinDelivery2024!@db:5432/apelsin_db
      - JWT_SECRET=your-super-secret-jwt-key-here
      - FTP_HOST=ftp
      - FTP_PORT=21
      - FTP_USER=apelsin_ftp
      - FTP_PASSWORD=ftp_password_here
      - FTP_DIRECTORY=/xml_uploads
    depends_on:
      - db
      - ftp
    restart: unless-stopped

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=apelsin_db
      - POSTGRES_USER=apelsin_user
      - POSTGRES_PASSWORD=ApelsinDelivery2024!
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-database.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    restart: unless-stopped

  ftp:
    image: stilliard/pure-ftpd
    environment:
      - PUBLICHOST=localhost
      - FTP_USER_NAME=apelsin_ftp
      - FTP_USER_PASS=ftp_password_here
      - FTP_USER_HOME=/home/apelsin_ftp
    volumes:
      - ftp_data:/home/apelsin_ftp
    ports:
      - "21:21"
      - "30000-30009:30000-30009"
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    restart: unless-stopped

volumes:
  postgres_data:
  ftp_data:
